<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Money Cockpit</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           background-color: #0b0e14; color: #e6e6e6; display: flex; }
    .sidebar { width: 240px; background: #11151d; padding: 20px 0; display: flex; flex-direction: column; height: 100vh;
               box-shadow: 2px 0 10px rgba(0,0,0,0.7); }
    .sidebar h2 { text-align: center; color: #39ff14; margin-bottom: 30px; text-shadow: 0 0 10px #39ff14; }
    .nav-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; color: #ccc; cursor: pointer; transition: all 0.3s ease; }
    .nav-item:hover { background: #1a1f2a; color: #39ff14; }
    .main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .chart { background: #161b25; border-radius: 15px; padding: 20px; box-shadow: 0 0 15px rgba(157,0,255,0.3); }
    .chart h3 { margin-top: 0; margin-bottom: 15px; color: #9d00ff; text-shadow: 0 0 5px #9d00ff; }
    .chart-canvas { height: 180px !important; max-height: 200px; width: 100% !important; display: block; }
    .labels-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; color: #e6e6e6; }
    .axis-markers { display: flex; flex-direction: column; justify-content: space-between; height: 180px; margin-right: 8px; font-size: 12px; color: #aaa; }
    .chart-wrapper { display: flex; align-items: center; }
    .legend { display: flex; gap: 15px; margin-top: 10px; font-size: 13px; }
    .legend span { display: flex; align-items: center; gap: 5px; }
    .legend .box { width: 12px; height: 12px; border-radius: 3px; }
    .tiles-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .tile { background: #161b25; border-radius: 15px; padding: 20px; box-shadow: 0 0 15px rgba(57,255,20,0.2); }
    .tile h3 { margin-top: 0; margin-bottom: 15px; color: #39ff14; text-shadow: 0 0 5px #39ff14; }
    .bottom-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .highlight { font-size: 24px; font-weight: bold; color: #39ff14; margin-bottom: 10px; text-shadow: 0 0 10px #39ff14, 0 0 15px #9d00ff; }
    .due-today { color: #ff4d4d; font-weight: bold; text-shadow: 0 0 10px #ff4d4d; }
    .categories-list { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .category-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .bar { height: 12px; border-radius: 6px; flex-grow: 1; transition: width 1.2s ease-in-out; }
    .label { width: 100px; text-align: right; color: #e6e6e6; }
    .value { width: 60px; text-align: right; color: #e6e6e6; }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ðŸ’¸ Cockpit</h2>
    <div class="nav-item"><i class="fas fa-home"></i> Dashboard</div>
    <div class="nav-item"><i class="fas fa-list"></i> Transactions</div>
    <div class="nav-item"><i class="fas fa-random"></i> Cash Flow</div>
    <div class="nav-item"><i class="fas fa-university"></i> Accounts</div>
    <div class="nav-item"><i class="fas fa-chart-line"></i> Investments</div>
    <div class="nav-item"><i class="fas fa-tags"></i> Categories</div>
    <div class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Recurring Bills</div>
    <div class="nav-item"><i class="fas fa-cog"></i> Settings</div>
  </div>

  <div class="main">
    <div class="charts-row">
      <div class="chart">
        <h3>Spendable vs Budget</h3>
        <div class="chart-wrapper">
          <div class="axis-markers"><span>$400</span><span>$300</span><span>$200</span><span>$100</span><span>$0</span></div>
          <canvas id="spendableChart" class="chart-canvas"></canvas>
        </div>
        <div class="labels-row"><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span></div>
        <div class="legend"><span><div class="box" style="background:#39ff14"></div> Spendable</span><span><div class="box" style="background:#9d00ff"></div> Budget</span></div>
      </div>
      <div class="chart">
        <h3>Daily Budget Trend</h3>
        <div class="chart-wrapper">
          <div class="axis-markers"><span>$150</span><span>$100</span><span>$50</span><span>$0</span></div>
          <canvas id="dailyChart" class="chart-canvas"></canvas>
        </div>
        <div class="labels-row"><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span></div>
      </div>
    </div>

    <div class="tiles-row">
      <div class="tile">
        <h3>Top Categories</h3>
        <div class="categories-list" id="categories-list"></div>
      </div>
      <div class="tile">
        <h3>Transactions To Review</h3>
        <div id="transactions-list"></div>
      </div>
    </div>

    <div class="bottom-row">
      <div class="tile">
        <h3>Monthly Income + Payday Countdown</h3>
        <div class="highlight" id="income">$0.00</div>
        <div>Next payday in <span class="due-today" id="payday">-- days</span></div>
      </div>
      <div class="tile">
        <h3>Recurring Bills (Next 2 Weeks)</h3>
        <div class="highlight">$1,410 Due</div>
        <div>Netflix â€“ $15.99</div>
        <div>Rent â€“ $1,200.00</div>
        <div class="due-today">Power â€“ $150.00</div>
        <div>Internet â€“ $45.00</div>
      </div>
    </div>
  </div>

  <script>
    let dailyBudget = 100;
    let categoryColors = {};

    async function fetchSettings() {
      const res = await fetch('/.netlify/functions/get_settings');
      const data = await res.json();
      dailyBudget = data.dailyBudget;
      categoryColors = data.categories;
    }

    async function fetchBalances() {
      const res = await fetch('/.netlify/functions/get_balances');
      const data = await res.json();
      let total = 0;
      data.accounts.forEach(acc => { total += acc.balances.available || 0; });
      document.getElementById('income').innerText = `$${total.toLocaleString()}`;
    }

    async function fetchTransactions() {
      const res = await fetch('/.netlify/functions/get_transactions');
      const data = await res.json();
      const txs = data.transactions.slice(0,5);
      document.getElementById('transactions-list').innerHTML = txs.map(t => `<div>${t.name} â€“ ${t.amount < 0 ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}</div>`).join("");
      buildCharts(data.transactions);
      buildCategories(data.transactions);
    }

    function buildCharts(transactions) {
      const dailySpend = {};
      for (let i=0;i<7;i++){ dailySpend[i]=0; }
      const now = new Date();
      transactions.forEach(t => {
        const d = new Date(t.date);
        const diff = Math.floor((now - d)/(1000*60*60*24));
        if (diff < 7) { dailySpend[6-diff] += Math.abs(t.amount); }
      });
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      new Chart(document.getElementById('spendableChart').getContext('2d'), {
        type:'line',
        data:{ labels:days, datasets:[
          {label:'Spendable', data:Object.values(dailySpend).map(v=>dailyBudget-v), borderColor:'#39ff14', tension:0.4},
          {label:'Budget', data:Array(7).fill(dailyBudget), borderColor:'#9d00ff', tension:0.4}
        ]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
      });
      new Chart(document.getElementById('dailyChart').getContext('2d'), {
        type:'bar',
        data:{ labels:days, datasets:[{label:'Daily Spend', data:Object.values(dailySpend), backgroundColor:'#39ff14'}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
      });
    }

    function buildCategories(transactions) {
      const sums = {};
      transactions.forEach(t=>{ const c=t.category?t.category[0]:"Other"; sums[c]=(sums[c]||0)+Math.abs(t.amount); });
      const list = Object.entries(sums).map(([cat,val])=>{
        const color = categoryColors[cat]||'#888';
        return `<div class="category-row"><div class="label">${cat}</div><div class="bar" style="background:${color};width:${Math.min(val/20,100)}%"></div><div class="value">$${val.toFixed(2)}</div></div>`;
      }).join("");
      document.getElementById('categories-list').innerHTML = list;
    }

    (async ()=>{ await fetchSettings(); await fetchBalances(); await fetchTransactions(); })();
  </script>
</body>
</html>