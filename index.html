<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Money Cockpit</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#0b0e14; color:#e6e6e6; font-family:sans-serif; margin:0; display:flex; }
    .sidebar { width:240px; background:#11151d; padding:20px 0; display:flex; flex-direction:column; height:100vh; box-shadow:2px 0 10px rgba(0,0,0,0.7); }
    .sidebar h2 { text-align:center; color:#39ff14; margin-bottom:30px; text-shadow:0 0 10px #39ff14; }
    .nav-item { padding:12px 20px; display:flex; align-items:center; gap:12px; color:#ccc; cursor:pointer; transition:all 0.3s ease; }
    .nav-item:hover { background:#1a1f2a; color:#39ff14; }
    .main { flex:1; padding:20px; display:flex; flex-direction:column; gap:20px; }
    .charts-row, .tiles-row, .bottom-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .chart, .tile { background:#161b25; border-radius:15px; padding:20px; box-shadow:0 0 15px rgba(57,255,20,0.2); }
    .chart h3, .tile h3 { margin:0 0 15px 0; color:#39ff14; text-shadow:0 0 5px #39ff14; }
    .chart h3 { color:#9d00ff; text-shadow:0 0 5px #9d00ff; }
    .chart-canvas { height:220px !important; width:100% !important; display:block; }
    .highlight { font-size:24px; font-weight:bold; color:#39ff14; text-shadow:0 0 10px #39ff14, 0 0 15px #9d00ff; }
    .due-today { color:#ff4d4d; font-weight:bold; text-shadow:0 0 10px #ff4d4d; }
    .categories-list { display:flex; flex-direction:column; gap:6px; }
    .category-row { display:flex; align-items:center; gap:10px; font-size:14px; }
    .bar { height:12px; border-radius:6px; flex-grow:1; transition:width 1.2s ease-in-out; }
    .label { width:100px; text-align:right; }
    .value { width:60px; text-align:right; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ðŸ’¸ Cockpit</h2>
    <div class="nav-item"><i class="fas fa-home"></i> Dashboard</div>
    <div class="nav-item"><i class="fas fa-list"></i> Transactions</div>
    <div class="nav-item"><i class="fas fa-chart-line"></i> Cash Flow</div>
    <div class="nav-item"><i class="fas fa-university"></i> Accounts</div>
    <div class="nav-item"><i class="fas fa-briefcase"></i> Investments</div>
    <div class="nav-item"><i class="fas fa-tags"></i> Categories</div>
    <div class="nav-item"><i class="fas fa-calendar-alt"></i> Recurring Bills</div>
    <div class="nav-item"><i class="fas fa-cog"></i> Settings</div>
  </div>
  <div class="main">
    <!-- Row 1: Charts -->
    <div class="charts-row">
      <div class="chart">
        <h3>Spendable vs Budget</h3>
        <canvas id="spendableChart" class="chart-canvas"></canvas>
      </div>
      <div class="chart">
        <h3>Daily Budget Trend</h3>
        <canvas id="dailyChart" class="chart-canvas"></canvas>
      </div>
    </div>
    <!-- Row 2: Categories + Transactions -->
    <div class="tiles-row">
      <div class="tile">
        <h3>Top Categories</h3>
        <div class="categories-list" id="categories-list"></div>
      </div>
      <div class="tile">
        <h3>Transactions To Review</h3>
        <div id="transactions-list"></div>
      </div>
    </div>
    <!-- Row 3: Income + Recurring Bills -->
    <div class="bottom-row">
      <div class="tile">
        <h3>Monthly Income + Payday Countdown</h3>
        <div class="highlight" id="income">$0.00</div>
        <div id="payday-info">Next payday in <span class="due-today" id="payday-countdown">-- days</span></div>
      </div>
      <div class="tile">
        <h3>Recurring Bills (Mock)</h3>
        <div class="highlight">$1,410 Due</div>
        <div>Netflix â€“ $15.99</div>
        <div>Rent â€“ $1,200.00</div>
        <div class="due-today">Power â€“ $150.00</div>
        <div>Internet â€“ $45.00</div>
      </div>
    </div>
  </div>
  <script>
    let dailyBudget = 100;
    let categoryColors = {};

    async function fetchSettings() {
      const res = await fetch('/.netlify/functions/get_settings');
      const data = await res.json();
      dailyBudget = data.dailyBudget;
      categoryColors = data.categories;
    }

    async function fetchBalances() {
      const res = await fetch('/.netlify/functions/get_balances');
      const data = await res.json();
      let total = 0;
      data.accounts.forEach(acc => { total += acc.balances.available || 0; });
      document.getElementById('income').innerText = `$${total.toLocaleString()}`;
    }

    async function fetchTransactions() {
      const res = await fetch('/.netlify/functions/get_transactions');
      const data = await res.json();
      const txs = data.transactions.slice(0,5);
      document.getElementById('transactions-list').innerHTML = txs.map(t => {
        let name = t.name;
        if (name.toLowerCase().includes("uber")) name = "Uber (Transport)";
        if (name.toLowerCase().includes("starbucks")) name = "Starbucks (Food & Drink)";
        if (name.toLowerCase().includes("netflix")) name = "Netflix (Entertainment)";
        if (name.toLowerCase().includes("amazon")) name = "Amazon (Shopping)";
        return `<div>${name} â€“ $${Math.abs(t.amount).toFixed(2)}</div>`;
      }).join("");
      buildCharts(data.transactions);
      buildCategories(data.transactions);
    }

    function buildCharts(transactions) {
      const dailySpend = {}; for (let i=0;i<7;i++){ dailySpend[i]=0; }
      const now = new Date();
      transactions.forEach(t => {
        const d = new Date(t.date);
        const diff = Math.floor((now - d)/(1000*60*60*24));
        if (diff < 7) dailySpend[6-diff] += Math.abs(t.amount);
      });
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      new Chart(document.getElementById('spendableChart').getContext('2d'), {
        type:'line',
        data:{ labels:days, datasets:[
          {label:'Spendable', data:Object.values(dailySpend).map(v=>dailyBudget-v), borderColor:'#39ff14', tension:0.4},
          {label:'Budget', data:Array(7).fill(dailyBudget), borderColor:'#9d00ff', tension:0.4}
        ]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
      });
      new Chart(document.getElementById('dailyChart').getContext('2d'), {
        type:'bar',
        data:{ labels:days, datasets:[{label:'Daily Spend', data:Object.values(dailySpend), backgroundColor:'#39ff14'}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
      });
    }

    function buildCategories(transactions) {
      const sums = {};
      transactions.forEach(t=>{ 
        let cat = t.category ? t.category[0] : "Other"; 
        if (t.name.toLowerCase().includes("starbucks")) cat = "Food & Drink";
        if (t.name.toLowerCase().includes("netflix")) cat = "Entertainment";
        if (t.name.toLowerCase().includes("amazon")) cat = "Shopping";
        sums[cat]=(sums[cat]||0)+Math.abs(t.amount); 
      });
      document.getElementById('categories-list').innerHTML = Object.entries(sums).map(([cat,val])=>{
        const color = categoryColors[cat]||'#888';
        return `<div class="category-row"><div class="label">${cat}</div><div class="bar" style="background:${color};width:${Math.min(val/20,100)}%"></div><div class="value">$${val.toFixed(2)}</div></div>`;
      }).join("");
    }

    function calculatePaydayCountdown() {
      const today = new Date();

      function adjustForWeekend(date) {
        if (date.getDay() === 0) date.setDate(date.getDate() - 2);
        if (date.getDay() === 6) date.setDate(date.getDate() - 1);
        return date;
      }

      const reference = new Date(2025, 0, 3);
      let nextYourPay = new Date(reference);
      while (nextYourPay <= today) nextYourPay.setDate(nextYourPay.getDate() + 14);
      let nextYourSofi = new Date(nextYourPay); nextYourSofi.setDate(nextYourPay.getDate() - 2);

      let nextWifePay;
      const day = today.getDate();
      const month = today.getMonth();
      if (day < 15) nextWifePay = adjustForWeekend(new Date(today.getFullYear(), month, 15));
      else if (day < 30) nextWifePay = adjustForWeekend(new Date(today.getFullYear(), month, 30));
      else nextWifePay = adjustForWeekend(new Date(today.getFullYear(), month + 1, 15));

      const candidates = [
        {date: nextYourPay, label: "BofA Payday"},
        {date: nextYourSofi, label: "SoFi Early Deposit"},
        {date: nextWifePay, label: "Wife Payday"}
      ];
      let soonest = candidates.reduce((a,b)=> a.date<b.date?a:b);
      const diffDays = Math.ceil((soonest.date - today) / (1000*60*60*24));

      document.getElementById('payday-countdown').innerText = diffDays + " days";
      document.getElementById('payday-info').innerHTML = `Next payday: ${soonest.label} in <span class="due-today">${diffDays} days</span>`;
    }

    (async ()=>{ 
      await fetchSettings(); 
      await fetchBalances(); 
      await fetchTransactions(); 
      calculatePaydayCountdown();
    })();
  </script>
</body>
</html>